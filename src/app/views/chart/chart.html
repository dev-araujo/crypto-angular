<section class="coin-detail">
  @if (loadingDetails$ | async) {
  <div class="card p-4">
    <div class="flex align-items-center gap-3 mb-4">
      <p-skeleton shape="circle" size="50px"></p-skeleton>
      <div class="flex-1">
        <p-skeleton width="40%" height="2rem" class="mb-2"></p-skeleton>
        <p-skeleton width="20%" height="1rem"></p-skeleton>
      </div>
    </div>
    
    <p-skeleton width="60%" height="3rem" class="mb-3"></p-skeleton>
    <p-skeleton width="30%" height="1.5rem" class="mb-3"></p-skeleton>
    <p-skeleton width="10rem" height="2.5rem" class="mb-4"></p-skeleton>

    <p-skeleton width="100%" height="25rem" class="mb-5"></p-skeleton>
    
    <h2 class="section-title"><p-skeleton width="12rem" height="1.5rem"></p-skeleton></h2>
    <div class="coin-detail__metrics-grid">
      @for (item of [1, 2, 3, 4, 5, 6]; track item) {
        <div class="metric-item">
          <p-skeleton width="8rem" height="1rem" class="mb-2"></p-skeleton>
          <p-skeleton width="10rem" height="1.2rem"></p-skeleton>
        </div>
      }
    </div>
  </div>
  } 
  
  @else if (detailsError$ | async; as error) {
  <div class="card p-4 text-center text-red-500">{{ error }}</div>
  } 
  
  @else if (coinDetails; as coin) {
    @if (currencyCode$ | async; as currencyCode) {
    <div class="card p-4">
      
      <div class="coin-detail__header">
        <img [src]="coin.iconUrl" [alt]="coin.name" class="coin-detail__icon" />
        <div>
          <h1 class="coin-detail__title">{{ coin.name }} ({{ coin.symbol }})</h1>
        </div>
        <p-tag [value]="'Rank ' + coin.rank" [rounded]="true"></p-tag>
      </div>

      <div class="coin-detail__price-section">
        <div class="price-value" [style.color]="coin.color">
          {{ coin.price | currency: currencyCode : 'symbol' : '1.2-8' }}
        </div>
        <div class="change-value"
          [ngClass]="{ 'negative': Number(coin.change) < 0, 'positive': Number(coin.change) >= 0 }">
          ({{ coin.change | number: '1.2-2' }}%) <span>24h</span>
        </div>
      </div>

      <div class="coin-detail__period-selector">
        <p-select [options]="timePeriods" [(ngModel)]="selectedPeriod" optionLabel="name"
          (ngModelChange)="onTimePeriodChange($event)" placeholder="Selecione o Período">
        </p-select>
      </div>

      <div class="coin-detail__chart-section">
        @if (loadingHistory$ | async) {
        <p-skeleton width="100%" height="25rem"></p-skeleton>
        } @else if (historyError$ | async; as error) {
        <div class="text-center text-red-500 pt-4">{{ error }}</div>
        } @else if (chartData) {
        <div class="chart-container">
          <p-chart type="line" [data]="chartData" [options]="chartOptions"></p-chart>
        </div>
        } @else {
        <div class="text-center text-500 pt-4">Nenhum dado de histórico de preço disponível para este período.</div>
        }
      </div>

      <h2 class="section-title">Detalhes</h2>
      <div class="coin-detail__metrics-grid">
        
        <div class="metric-item">
          <span class="metric-item__title">Market Capitalization</span>
          <span class="metric-item__value">{{ coin.marketCap | currency: currencyCode : 'symbol' }}</span>
        </div>
        <div class="metric-item">
          <span class="metric-item__title">All Time High</span>
          <span class="metric-item__value">{{ coin.allTimeHigh.price | currency: currencyCode : 'symbol' : '1.2-8' }}</span>
        </div>
         <div class="metric-item">
          <span class="metric-item__title">All Time High Date</span>
          <span class="metric-item__value">{{ coin.allTimeHigh.timestamp * 1000 | date: 'mediumDate' }}</span>
        </div>

        <div class="metric-item">
          <span class="metric-item__title">Volume (24h)</span>
          <span class="metric-item__value">{{ coin['24hVolume'] | currency: currencyCode : 'symbol' }}</span>
        </div>
        <div class="metric-item">
          <span class="metric-item__title">Circulating Supply</span>
          <span class="metric-item__value">{{ coin.supply.circulating | number }} {{ coin.symbol }}</span>
        </div>
        <div class="metric-item metric-item--description">
          <span class="metric-item__title">Description</span>
          <div class="description-content" [innerHTML]="coin.description"></div>
        </div>
      </div>

      <h2 class="section-title">Links</h2>
      <div class="coin-detail__links-grid">
        @for (link of coin.links; track link.url) {
        <a [href]="link.url" target="_blank" class="p-button p-component p-button-outlined">
          <span class="pi pi-external-link mr-2"></span>
          {{ link.name }} ({{ link.type }})
        </a>
        }
        <a [href]="coin.websiteUrl" target="_blank" class="p-button p-component p-button-outlined">
          <span class="pi pi-globe mr-2"></span>
          Website
        </a>
      </div>

    </div>
    }
  }
</section>